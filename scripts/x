#!/bin/bash

# Docker devcontainer helper script
# Run commands in the Docker container specified in .devcontainer/devcontainer.json

# Handle special subcommands first
# Only trigger subcommands if it's the only argument (no other args)
if [ $# -eq 1 ]; then
    case "$1" in
        "code"|"open")
            "$HOME/.local/bin/devcontainer-insiders" open
            exit $?
            ;;
        "up")
            "$HOME/.local/bin/devcontainer-insiders" up
            exit $?
            ;;
        "down")
            docker compose down
            exit $?
            ;;
        "stop")
            docker compose stop
            exit $?
            ;;
        "rm")
            docker compose rm
            exit $?
            ;;
        "build")
            "$HOME/.local/bin/devcontainer-insiders" build
            exit $?
            ;;
    esac
fi

# Validate environment
if [ ! -f ".devcontainer/devcontainer.json" ]; then
    echo "‚ùå .devcontainer/devcontainer.json not found"
    exit 1
fi

if ! command -v jq &> /dev/null; then
    echo "‚ùå jq is required but not installed"
    echo "üí° Install with: brew install jq"
    exit 1
fi

# Parse devcontainer config
service=$(json5 .devcontainer/devcontainer.json | jq -r '.service')
remote_user=$(json5 .devcontainer/devcontainer.json | jq -r '.remoteUser')

if [ -z "$service" ]; then
    echo "‚ùå Could not find 'service' in .devcontainer/devcontainer.json"
    exit 1
fi

# Build docker command
docker_cmd="docker-compose exec"
[ -n "$remote_user" ] && docker_cmd="$docker_cmd -u $remote_user"

# Execute command or start shell
if [ $# -eq 0 ]; then
    eval "$docker_cmd $service zsh"
else
    eval "$docker_cmd $service zsh -i -c \"$*\""
fi