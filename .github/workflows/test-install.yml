name: Test Installation Script

on:
    push:
        branches: [main, master]
        paths:
            - "install.sh"
            - ".zshrc"
            - ".github/workflows/test-install.yml"
    pull_request:
        branches: [main, master]
        paths:
            - "install.sh"
            - ".zshrc"
            - ".github/workflows/test-install.yml"
    workflow_dispatch:

jobs:
    test-install:
        runs-on: macos-latest

        env:
            HOMEBREW_NO_AUTO_UPDATE: 1
            HOMEBREW_NO_INSTALL_CLEANUP: 1

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Cache Homebrew packages
              uses: actions/cache@v4
              with:
                  path: |
                      ~/Library/Caches/Homebrew
                      /opt/homebrew/Cellar
                      /opt/homebrew/Caskroom
                  key: ${{ runner.os }}-homebrew-${{ hashFiles('install.sh') }}
                  restore-keys: |
                      ${{ runner.os }}-homebrew-

            - name: Cache Zinit and plugins
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.local/share/zinit
                  key: ${{ runner.os }}-zinit-${{ hashFiles('.zshrc') }}
                  restore-keys: |
                      ${{ runner.os }}-zinit-

            - name: Cache Node.js tools
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.bun
                      ~/.local/share/fnm
                  key: ${{ runner.os }}-node-tools-v1
                  restore-keys: |
                      ${{ runner.os }}-node-tools-

            - name: Verify script syntax
              run: bash -n install.sh

            - name: Run install script
              run: chmod +x install.sh && ./install.sh

            - name: Verify Homebrew
              run: brew --version

            - name: Verify Zinit installation
              run: |
                  test -d "$HOME/.local/share/zinit/zinit.git"
                  echo "✓ Zinit installed"

            - name: Verify essential tools
              run: |
                  export PATH="$HOME/.bun/bin:$PATH"

                  tools=(git docker gh aws zoxide starship eza fnm pnpm bun fzf bat)

                  for tool in "${tools[@]}"; do
                    command -v "$tool" >/dev/null 2>&1 && echo "✓ $tool" || { echo "✗ $tool"; exit 1; }
                  done

            - name: Verify config files
              run: |
                  test -f "$HOME/.zshrc"
                  test -f "$HOME/.env.sh"
                  echo "✓ Config files"

            - name: Verify directories
              run: |
                  test -d "$HOME/.local/bin"
                  test -d "$HOME/.local/share"
                  test -d "$HOME/.docker/completions"
                  test -d "$HOME/.eza/completions/zsh"
                  echo "✓ Directories created"

            - name: Verify dnsmasq
              run: |
                  test -f "$(brew --prefix)/etc/dnsmasq.conf"
                  grep -q "address=/.test/127.0.0.1" "$(brew --prefix)/etc/dnsmasq.conf"
                  echo "✓ dnsmasq configured"

            - name: Test zsh config loads
              run: zsh -c "source $HOME/.zshrc && echo '✓ zshrc loads'"

            - name: Verify Docker
              run: |
                  docker --version
                  docker compose version || docker-compose --version || true
                  echo "✓ Docker CLI available"

            - name: Generate report
              run: |
                  echo "## Installation Test Report" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Tools:" >> $GITHUB_STEP_SUMMARY
                  echo "- Homebrew: $(brew --version | head -1)" >> $GITHUB_STEP_SUMMARY
                  echo "- Git: $(git --version)" >> $GITHUB_STEP_SUMMARY
                  echo "- Docker: $(docker --version)" >> $GITHUB_STEP_SUMMARY
                  echo "- Bun: $($HOME/.bun/bin/bun --version)" >> $GITHUB_STEP_SUMMARY
                  echo "- Starship: $(starship --version)" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Setup:" >> $GITHUB_STEP_SUMMARY
                  echo "- Zinit: ✓" >> $GITHUB_STEP_SUMMARY
                  echo "- dnsmasq: ✓" >> $GITHUB_STEP_SUMMARY
